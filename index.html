<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Sequence Observer - Reconnaissance</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        #root { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .recon-log { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: monospace; margin-top: 20px; font-size: 0.9em; }
        .recon-log h4 { color: #569cd6; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .control-panel { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: white; }
        button.del-btn { background: #ef4444; margin-left: 5px; }
        button.edit-btn { background: #64748b; margin-left: 10px; }
        li { margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; display: flex; align-items: center; }
        li span { flex: 1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // 일꾼이 쓸 도구함
        const Store = { tasks: [], traces: [] };

        const App = {
            // [중앙 집행부] 모든 요청은 이 통로를 거친다. // 이러니까 결합도가 또 높아졌죠?
            // 정찰기만 지워야 하는데, 여기를 관통해야만 하니까 탈부착이 안되잖소!
            async request(url, method = 'GET', body = null) {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);

                const res = await fetch(url, options);
                
                // [정찰 보고서] 서버가 준 X-Sequence-Trace를 뜯어서 저장
                const traceHeader = res.headers.get('X-Sequence-Trace');
                if (traceHeader) Store.traces = JSON.parse(traceHeader);

                const data = await res.json();
                
                // Read 요청일 때는 데이터를 보관함에 넣기
                if (method === 'GET' && data.tasks) Store.tasks = data.tasks;
                
                this.render();
                return { ok: res.ok, data };
            },

            // CRUD: 읽기 (기본 로딩)
            async loadTasks() { await this.request('/api/tasks'); },

            // CRUD: 생성
            async addTask() {
                const input = document.getElementById('taskInput');
                if (!input.value) return;
                await this.request('/api/tasks', 'POST', { task: input.value });
                input.value = '';
                await this.loadTasks(); // 저장했으면 새로 읽어와야지.
            },

            // CRUD: 수정
            async updateTask(index) {
                const newTask = prompt("수정할 내용을 입력하세요:", Store.tasks[index]);
                if (newTask === null) return; // 취소하면 관둬.
                await this.request('/api/tasks', 'PUT', { index, task: newTask });
                await this.loadTasks(); // 고쳤으면 다시 확인해.
            },

            // CRUD: 삭제
            async deleteTask(index) {
                if (!confirm("이 시퀀스를 제거할까요?")) return;
                await this.request('/api/tasks', 'DELETE', { index });
                await this.loadTasks(); // 지웠으면 목록 갱신해.
            },

            render() {
                const root = document.getElementById('root');
                root.innerHTML = `
                    <h3>Sequence Manager</h3>
                    
                    <div class="control-panel">
                        <input type="text" id="taskInput" placeholder="기록할 과업 명칭...">
                        <button onclick="App.addTask()">과업 확정</button>
                    </div>

                    <div class="content-view">
                        <h4>Storage List</h4>
                        <ul>
                            ${Store.tasks.length > 0 
                                ? Store.tasks.map((t, i) => `
                                    <li>
                                        <span>${t}</span>
                                        <button class="edit-btn" onclick="App.updateTask(${i})">수정</button>
                                        <button class="del-btn" onclick="App.deleteTask(${i})">삭제</button>
                                    </li>`).join('') 
                                : '<li>비어 있는 저장소입니다.</li>'}
                        </ul>
                    </div>

                    <div class="recon-log">
                        <h4>Reconnaissance: Sequence Trace</h4>
                        <div class="trace-box" style="background: #121212; border: 1px solid #333; padding: 12px;">
                            ${Store.traces.map(t => `
                                <div class="event-line" style="border-bottom: 1px solid #222; padding: 4px 0;">
                                    <span class="event-tag" style="color: #dcdcaa; font-weight: bold;">[${t.event}]</span> 
                                    <span class="event-payload" style="color: #9cdcfe; font-size: 0.9em;">${JSON.stringify(t.data)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        };

        // 시작하자마자 일단 읽어.
        window.onload = () => App.loadTasks();
    </script>
</body>
</html>